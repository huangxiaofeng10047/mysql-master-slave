## Mysql 8.0 ä¸€ä¸»ä¸€ä»è¯¦ç»†é…ç½®æ–¹æ¡ˆ

- æœ¬æ–‡æ˜¯åœ¨Mac ä¸‹æ“ä½œï¼ˆDocker è‡ªè¡Œå®‰è£…ï¼‰
- ä½¿ç”¨docker-composer è¿›è¡Œå®‰è£… 

## ä¸€ã€å®‰è£…

```
#ä¸‹è½½
git clone git@github.com:Flttgo/mysql-master-slave.git

#è¿›å…¥å­ç›®å½•
cd mysql-master-slave

#å¼€å§‹å®‰è£…
docker-compose up -d
```

çœ‹åˆ°å¦‚ä¸‹æ•ˆæœè¡¨ç¤ºå¯åŠ¨æˆåŠŸ
```
$ docker-compose up -d
Creating mysql-salve  ... done
Creating mysql-master ... done
```

å‘½ä»¤è¡ŒæŸ¥çœ‹æˆ‘ä»¬åˆ›å»ºçš„é•œåƒ

<img src="./images/WX20230316-172232@2x.png" width="600px">

```code
$ docker ps --format "table {{.ID}}\t{{.Names}}\t{{.Networks}}" --filter 'network=mysql-master-slave_default'
CONTAINER ID   NAMES          NETWORKS
09e55faa27a8   mysql-salve    mysql-master-slave_default
e12f9e07e2ea   mysql-master   mysql-master-slave_default
```

<img src="./images/3@2x.png" width="600px">


Docker å·¥å…·æŸ¥çœ‹é•œåƒï¼š


<img src="./images/2@2x.png" width="600px">

å‡å·²æ­£å¸¸å¯åŠ¨ï¼Œæ­¤æ—¶å¦‚æœæˆ‘ä»¬æœ¬åœ°å®¿ä¸»æœºå¦‚æœéœ€è¦è¿æ¥ï¼Œé…ç½®å¦‚ä¸‹ï¼š

ä¸»åº“ï¼š
IPï¼š 127.0.0.1 PORT: 33060 USER: root password: 123456

ä»åº“è¿æ¥æ–¹å¼ï¼š[åªè¯»æ¨¡å¼]
IPï¼š 127.0.0.1 PORT: 33070 USER: root password: 123456

## äºŒã€åˆ›å»ºé›†ç¾¤å¤åˆ¶è´¦æˆ·ã€ä¸»åº“æ“ä½œã€‘

ä½¿ç”¨`Item2` è¿›è¡Œè¿æ¥ä¸»åº“[mysql-master]

`docker exec -it mysql-master /bin/bash`

<img src="./images/4@2x.png" width="600px">

è¿æ¥æ•°æ®åº“:[æˆ‘ä»¬é…ç½®çš„ç«¯å£æ˜¯3309 è¯¦æƒ…è§

 `./services/mysql/master/my.cnf`]

`mysql -uroot -p123456 -P3309`

<img src="./images/6@2x.png" width="600px">

æŸ¥çœ‹æ•°æ®åº“ç°æœ‰ç”¨æˆ·åŠ å¯†æ–¹å¼å’Œå·²æœ‰ç”¨æˆ·ï¼š

`select Host,User,Plugin from mysql.user;`

<img src="./images/7@2x.png" width="600px">

åˆ›å»ºä¸»ä»å¤åˆ¶è´¦æˆ·

```

# åˆ›å»ºå¤åˆ¶ç”¨æˆ·
create user 'repl'@'%' identified by '123456';

# æˆæƒèµ‹å€¼ å¤åˆ¶æƒé™
grant replication slave,replication client on *.* to 'repl'@'%';
# åˆ·æ–°æƒé™
flush privileges;

```
å¦‚æœåˆ›å»ºç”¨æˆ·ä½¿ç”¨

 `CREATE USER 'slave'@'%' IDENTIFIED WITH 'mysql_native_password' BY '123456';`

 åˆ™åœ¨ä»åº“è¿æ¥æ—¶å»æ‰ `get_master_public_key` å‚æ•°ï¼Œå¦åˆ™ä¼šå‡ºç° `slave connecting to master`

å¦‚å›¾æ“ä½œ

<img src="./images/10@2x.png" width="600px">

å†æ¬¡æŸ¥è¯¢ç”¨æˆ·

<img src="./images/11@2x.png" width="600px">

ç”¨æˆ·`repl` æ·»åŠ æˆåŠŸï¼Œå¯†ç åŠ å¯†æ–¹å¼ å— `my.cnf` å†…çš„ `default-authentication-plugin` å½±å“


my.cnf é…ç½®

```
[mysqld]
#default-authentication-plugin   = mysql_native_password | caching_sha2_password ï¼ˆäºŒé€‰ä¸€ï¼Œ8.0 ä¹‹å é»˜è®¤æ˜¯åè€…ï¼‰
```

æŸ¥çœ‹å½“å‰mysql é»˜è®¤çš„å¯†ç åŠ å¯†æ–¹å¼

`show variables like '%plugin%'`

<img src="./images/12@2x.png" width="600px">


æŸ¥çœ‹ä¸»åº“ç›®å‰`binlog` æ—¥å¿—æ–‡ä»¶ç´¢å¼•

`show master logs;`

<img src="./images/13@2x.png" width="600px">

é‡ç½®ä¸»åº“æ—¥å¿—å¹¶å†æ¬¡æŸ¥è¯¢ï¼š

`reset master`

<img src="./images/14@2x.png" width="600px">

## ä¸‰ã€é…ç½®ä»åº“åˆ°ä¸»åº“çš„ä¸»ä»å¤åˆ¶è¿æ¥ã€å¾ˆé‡è¦ã€‘

è¿æ¥ä»åº“å®¹å™¨ï¼š

`docker exec -it mysql-slave /bin/bash`

<img src="./images/15@2x.png" width="600px">

è¿æ¥å®¹å™¨å†…mysql[å‚è€ƒä¸»åº“æ–¹å¼]:

`mysql -uroot -p123456 -P3310`


<img src="./images/16@2x.png" width="600px">

æŸ¥çœ‹ä¸»åº“å®¹å™¨IP

`docker inspect --format='{{.Name}} - {{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' $(docker ps -aq)`

æˆ‘ç”µè„‘ä½¿ç”¨äº†zsh è„šæœ¬

```text
function docker_ip_all() {
	docker inspect --format='{{.Name}} - {{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' $(docker ps -aq)
}
```

<img src="./images/17@2x.png" width="600px">

ä¸»åº“IPï¼ˆä½ ä»¬é…ç½®è¯·æ ¹æ®æŸ¥çœ‹åˆ°çš„IPå®šä¹‰ï¼‰ï¼š

mysql-master: 172.29.0.3(ä¸»åº“ï¼Œæ³¨æ„IPå¯èƒ½ä¼šå˜åŠ¨)

mysql-slave: 172.29.0.2ï¼ˆä»åº“ï¼Œæ³¨æ„IPå¯èƒ½ä¼šå˜åŠ¨ï¼‰

æœ€å…³é”®ä¸€æ­¥ï¼Œè®¾ç½®ä»åº“è¿æ¥ä¸»åº“ã€ä»åº“æ‰§è¡Œã€‘ï¼š

```
change master to 
master_host='192.167.11.2',
master_port=3309,
master_user='repl',
master_password='123456',
master_log_file='mysql-bin.000001',
master_log_pos=156,
get_master_public_key=1
;
```

<img src="./images/20@2x.png" width="600px">

é…ç½®è¯´æ˜ï¼š

`master_log_file`ï¼šæ‰§è¡Œ[ä¸»åº“]show master logs çœ‹åˆ°çš„æ–‡ä»¶å

`m`aster_log_pos`ï¼š æ‰§è¡Œ[ä¸»åº“]show master logs çœ‹åˆ°çš„postion

`get_master_public_key`: ä½¿ç”¨Masterä¸»åº“å…¬é’¥éªŒè¯ï¼Œæ­¤å‚æ•°ç”±1 å’Œ 0 ï¼Œ1 ä½¿ç”¨ caching_sha2_password è¿›è¡Œå¯†ç éªŒè¯ 0 ä½¿ç”¨ mysql_native_password éªŒè¯ï¼Œæˆ‘ä»¬è¦çœ‹åˆ›å»ºå¤åˆ¶ç”¨æˆ·ä½¿ç”¨çš„æ˜¯é‚£ä¸ªåŠ å¯†æ–¹å¼ï¼Œå…·ä½“å‚è€ƒä¸Šé¢åˆ›å»ºç”¨æˆ·

binlog æ—¥å¿—ä½ç½® ä½äºmysqlæ•°æ®ç›®å½•


<img src="./images/19@2x.png" width="600px">

æ‰§è¡Œä¹‹åæŸ¥çœ‹ä»åº“æ˜¯å¦å¯ä¸»åº“è¿æ¥æˆåŠŸ:

```
Slave_IO_Running: No æœªå¯åŠ¨
Slave_SQL_Running: No æœªå¯åŠ¨
```

<img src="./images/21@2x.png" width="600px">

å¯åŠ¨ä»åº“å‘½ä»¤ï¼š
1. start slave å¼€å¯ä»åº“å¤åˆ¶çº¿ç¨‹
2. stop slave åœæ­¢å¤åˆ¶çº¿ç¨‹
3. reset slave é‡ç½®ä»è¿æ¥ï¼Œä¼šæ¸…ç†replay-log æ—¥å¿—

å¯åŠ¨å¦‚ä¸‹:

<img src="./images/22@2x.png" width="600px">

```
Slave_IO_Running: Yes
Slave_SQL_Running: Yes
```

çœ‹åˆ°è¿™ä¸¤ä¸ªå‚æ•°å‡ä¸º Yes æ­¤æ—¶ä»£è¡¨ ä¸»ä»å¤åˆ¶åŠŸèƒ½å·²ç»å¼€å¯ï¼Œé…ç½®å·¥ä½œå·²ç»ç»“æŸ

ä¸»ä»åŒæ­¥ä¸€å®šè¦ç¡®ä¿ å¼€å¯ `log-bin`

ä¸»ç¨‹åºé…ç½®å‚è§ç›®å½•env

 `MYSQL_CONF_FILE=./services/mysql/master/my.cnf`

ä»åº“é…ç½®ç›®å½•env:

 `MYSQL_CONF_FILE=./services/mysql/slave/my.cnf`

 é…ç½®ä»åº“åªè¯»ï¼š

```
 # é’ˆå¯¹superæƒé™ç”¨æˆ·å¦‚root å…·å¤‡super æƒé™ super_read_only é…ç½®ä¼šé»˜è®¤å¼€å¯ read_only 
 super_read_only=1
 # æ§åˆ¶ésuper æƒé™ç”¨æ“ä½œ
 #read_only=1
```

æ­¤æ—¶æ“ä½œ

<img src="./images/23@2x.png" width="600px">

æ­¤æ—¶  root ç”¨æˆ·å…·å¤‡  super æƒé™ï¼Œä¾ç„¶èƒ½æ“ä½œæ•°æ®åº“

æˆ‘ä»¬åªéœ€è¦å¼€å¯  super_read_only=1 æ³¨é‡Šæ‰ read_only =1 æ“ä½œï¼Œé‡å¯å³å¯

<img src="./images/24@2x.png" width="600px">

å°è¯•å¾€ä»åº“æ·»åŠ æ•°æ®åº“ï¼š

<img src="./images/25@2x.png" width="600px">

`ERROR 1290 (HY000): The MySQL server is running with the --super-read-only option so it cannot execute this statement` æç¤ºåªè¯»ï¼Œæ— æ³•æ“ä½œï¼Œä¿è¯ä¸»ä»çš„ä¸€è‡´æ€§

ä¸‹é¢æˆ‘ä»¬ä»ä¸»åº“åˆ›å»ºæ•°æ®åº“ï¼ŒæŸ¥çœ‹ä¸»ä»æ˜¯å¦å·¥ä½œï¼š

<img src="./images/27@2x.png" width="600px">

æˆ‘ä»¬å·¦ä¾§åˆ›å»ºä¸»åº“ï¼Œå³ä¾§æŸ¥è¯¢ `show databases;` å¯ä»¥çœ‹åˆ°å·²ç»åŒæ­¥æˆåŠŸ

ä»åº“æ‰§è¡Œï¼š `show master logs;`

å¾—åˆ°æœ€åä¸€æ¡æœ€æ–°çš„æ—¥å¿—ä¸ºï¼š `mysql-bin.0000004`

æŸ¥çœ‹æ—¥å¿—å†…å®¹ï¼š

`show binlog events in 'mysql-bin.000004'\G;`

<img src="./images/28@2x.png" width="600px">

ä¸Šå›¾ä¸­æˆ‘ä»¬æ˜¯èƒ½çœ‹åˆ° åˆ›å»ºæ•°æ®åº“çš„æ“ä½œè¯­å¥ 

## æ€»ç»“

å¦‚æœæœ‰åŒå­¦éœ€è¦ç”¨åˆ° binlog æŸ¥çœ‹å’Œå›æ»šå·¥å…·

[ä½¿ç”¨Mysql Binlogå·¥å…· binlog2sql](https://learnku.com/articles/75828)

ä¸­é—´å¯èƒ½ä¼šæœ‰å‘ï¼Œä¸ä¼šå¾ˆé¡ºåˆ©ï¼Œç«¯å£å·å„ç§é—®é¢˜


```
create USER 'root'@'%' IDENTIFIED BY '123456';
ALTER USER 'root'@'localhost' IDENTIFIED BY '123456';


flush privileges;

alter user 'root'@'%' identified with mysql_native_password by '123456';




change master to 
master_host='192.167.11.2',
master_port=3309,
master_user='repl',
master_password='123456',
master_log_file='mysql-bin.000001',
master_log_pos=156,
get_master_public_key=1
;

create table if not exists user 
(
  id bigint(20) not null auto_increment,
  name varchar(255)      default '',
  age int(11)      not null     default 0,
  sex tinyint(3)      not null     default '0',
 phone varchar(45)    not null  default '',
 primary key (id)
) engine=InnoDB auto_increment=3
default charset=utf8;

#æˆæƒ ç»™rootç”¨æˆ·
grant all privileges on *.* to 'root'@'%' with grant option; 
```

è¿›è¡Œä¸»ä»å»¶è¿Ÿæµ‹è¯•
create user 'pt_checksum'@'%' identified by '123456';

GRANT SELECT, PROCESS, SUPER, REPLICATION SLAVE ON *.* TO 'pt_checksum'@'%' with grant option;

grant all privileges on test.* to pt_checksum@'%';   


pt-heartbeat h='10.246.131.14',u='pt_checksum',p='123456',P=30306 -D  test --create-table --interval=1 --update --replace --daemonize
# ps -ef|grep heartbeat
```
ğŸ‘‰ğŸ‘‰ğŸ‘‰â¡ï¸ â¡ï¸ â¡ï¸  ps -ef|grep heartbeat
xfhuang  1564643   36298  0 16:11 ?        00:00:01 perl /usr/bin/site_perl/pt-heartbeat h=127.0.0.1,u=pt_checksum,p=123456,P=3309 -D test --create-table --interval=1 --update --replace --daemonize
xfhuang  1640242  620527  0 16:31 pts/15   00:00:00 grep heartbeat
```


pt-heartbeat h='10.246.131.14',u='pt_checksum',p='123456',P=30306 -D test --table=heartbeat --monitor --master-server-id=100 --frames=1m,2m,3m,4m
```
ğŸ‘‰ğŸ‘‰ğŸ‘‰â¡ï¸ â¡ï¸ â¡ï¸  pt-heartbeat h='127.0.0.1',u='pt_checksum',p='123456',P=3309 -D test --table=heartbeat --monitor --master-server-id=100
```
